/**
 * \addtogroup staticnet
 * @{
 */

#define DEBUG 0
#if DEBUG
#define PRINTF(...) printf(__VA_ARGS__)
#else
#define PRINTF(...)
#endif


#include <stdio.h>
#include "contikimac.h"
#include "dev/leds.h"
#include "net/linkaddr.h"
#include "net/netstack.h"
#include "net/rime/rime.h"
#include "net/mac/mac.h"
#include "random.h"
#include "sys/ctimer.h"
#include "aggregation.h"

#include "lib/list.h"


#ifdef RIME_CONF_BROADCAST_ANNOUNCEMENT_CHANNEL
#define BROADCAST_ANNOUNCEMENT_CHANNEL RIME_CONF_BROADCAST_ANNOUNCEMENT_CHANNEL
#else /* RIME_CONF_BROADCAST_ANNOUNCEMENT_CHANNEL */
#define BROADCAST_ANNOUNCEMENT_CHANNEL 2
#endif /* RIME_CONF_BROADCAST_ANNOUNCEMENT_CHANNEL */

#ifdef RIME_CONF_BROADCAST_ANNOUNCEMENT_BUMP_TIME
#define BROADCAST_ANNOUNCEMENT_BUMP_TIME RIME_CONF_BROADCAST_ANNOUNCEMENT_BUMP_TIME
#else /* RIME_CONF_BROADCAST_ANNOUNCEMENT_BUMP_TIME */
#define BROADCAST_ANNOUNCEMENT_BUMP_TIME CLOCK_SECOND * 32 / NETSTACK_RDC_CHANNEL_CHECK_RATE
#endif /* RIME_CONF_BROADCAST_ANNOUNCEMENT_BUMP_TIME */

#ifdef RIME_CONF_BROADCAST_ANNOUNCEMENT_MIN_TIME
#define BROADCAST_ANNOUNCEMENT_MIN_TIME RIME_CONF_BROADCAST_ANNOUNCEMENT_MIN_TIME
#else /* RIME_CONF_BROADCAST_ANNOUNCEMENT_MIN_TIME */
#define BROADCAST_ANNOUNCEMENT_MIN_TIME CLOCK_SECOND * 60
#endif /* RIME_CONF_BROADCAST_ANNOUNCEMENT_MIN_TIME */

#ifdef RIME_CONF_BROADCAST_ANNOUNCEMENT_MAX_TIME
#define BROADCAST_ANNOUNCEMENT_MAX_TIME RIME_CONF_BROADCAST_ANNOUNCEMENT_MAX_TIME
#else /* RIME_CONF_BROADCAST_ANNOUNCEMENT_MAX_TIME */
#define BROADCAST_ANNOUNCEMENT_MAX_TIME CLOCK_SECOND * 3600UL
#endif /* RIME_CONF_BROADCAST_ANNOUNCEMENT_MAX_TIME */

// Next dest table using final value{source, final destination}
int routing_table[45][45] =
{
// 0=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0},
// 1=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  0,  2,  3,  2,  2,  3,  3,  3,  2,  3,  3,  3,  2,  2,  2,  2,  2,  3,  3,  3,  2,  2,  2,  3,  3,  3,  2,  2,  2,  3,  3,  3,  2,  2,  2,  3,  3,  3,  2,  2,  2,  3,  3,  3},
// 2=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  1,  0,  3,  4,  5,  3,  3,  3,  4,  3,  3,  3,  4,  5,  4,  4,  5,  3,  3,  3,  4,  4,  5,  3,  3,  3,  5,  5,  4,  3,  3,  3,  4,  4,  5,  3,  3,  3,  4,  4,  5,  3,  3,  3},
// 3=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  1,  2,  0,  2,  2,  6,  7,  8,  2,  6,  6,  8,  2,  2,  2,  2,  2,  6,  6,  8,  2,  2,  2,  8,  8,  6,  2,  2,  2,  8,  6,  6,  2,  2,  2,  8,  8,  8,  2,  2,  2,  8,  6,  8},
// 4=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  2,  2,  2,  0,  5,  2,  2,  2,  9,  2,  2,  2, 13,  5,  9, 13,  5,  2,  2,  2,  9,  9,  5,  2,  2,  2,  5,  5,  9,  2,  2,  2, 13, 13,  5,  2,  2,  2, 13, 13,  5,  2,  2,  2},
// 5=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  2,  2,  2,  4,  0,  2,  2,  2,  4,  2,  2,  2,  4, 14,  4,  4, 14,  2,  2,  2,  4,  4, 14,  2,  2,  2, 14, 14,  4,  2,  2,  2,  4,  4, 14,  2,  2,  2,  4,  4, 14,  2,  2,  2},
// 6=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  3,  3,  3,  3,  3,  0,  7,  8,  3, 10, 11,  8,  3,  3,  3,  3,  3, 10, 11,  8,  3,  3,  3,  8,  8, 10,  3,  3,  3,  8, 10, 10,  3,  3,  3,  8,  8,  8,  3,  3,  3,  8, 11,  8},
// 7=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  3,  3,  3,  3,  3,  6,  0,  8,  3,  6,  6,  8,  3,  3,  3,  3,  3,  6,  6,  8,  3,  3,  3,  8,  8,  6,  3,  3,  3,  8,  6,  6,  3,  3,  3,  8,  8,  8,  3,  3,  3,  8,  6,  8},
// 8=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  3,  3,  3,  3,  3,  6,  7,  0,  3,  6,  6, 12,  3,  3,  3,  3,  3,  6,  6, 12,  3,  3,  3, 12, 12,  6,  3,  3,  3, 12,  6,  6,  3,  3,  3, 12, 12, 38,  3,  3,  3, 12,  6, 38},
// 9=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  4,  4,  4,  4,  4,  4,  4,  4,  0,  4,  4,  4, 13,  4, 15, 13,  4,  4,  4,  4, 15, 15,  4,  4,  4,  4,  4,  4, 15,  4,  4,  4, 13, 13,  4,  4,  4,  4, 13, 13,  4,  4,  4,  4},
//10=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  6,  6,  6,  6,  6,  6,  6,  6,  6,  0, 11,  6,  6,  6,  6,  6,  6, 18, 11,  6,  6,  6,  6,  6,  6, 18,  6,  6,  6,  6, 18, 18,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6, 11,  6},
//11=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  6,  6,  6,  6,  6,  6,  6,  6,  6, 10,  0,  6,  6,  6,  6,  6,  6, 10, 19,  6,  6,  6,  6,  6,  6, 10,  6,  6,  6,  6, 10, 10,  6,  6,  6,  6,  6,  6,  6,  6,  6,  6, 19,  6},
//12=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  0,  8,  8,  8,  8,  8,  8,  8, 20,  8,  8,  8, 20, 20,  8,  8,  8,  8, 20,  8,  8,  8,  8,  8, 20, 20, 38,  8,  8,  8, 20,  8, 38},
//13=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  4,  4,  4,  4,  4,  4,  4,  4,  9,  4,  4,  4,  0,  4,  9, 16,  4,  4,  4,  4,  9,  9,  4,  4,  4,  4,  4,  4,  9,  4,  4,  4, 16, 16,  4,  4,  4,  4, 16, 16,  4,  4,  4,  4},
//14=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  0,  5,  5, 17,  5,  5,  5,  5,  5, 17,  5,  5,  5, 17, 17,  5,  5,  5,  5,  5,  5, 17,  5,  5,  5,  5,  5, 17,  5,  5,  5},
//15=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  0,  9,  9,  9,  9,  9, 21, 22,  9,  9,  9,  9,  9,  9, 21,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9,  9},
//16=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,  0, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 33, 34, 13, 13, 13, 13, 33, 33, 13, 13, 13, 13},
//17=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14,  0, 14, 14, 14, 14, 14, 23, 14, 14, 14, 23, 23, 14, 14, 14, 14, 14, 14, 23, 14, 14, 14, 14, 14, 23, 14, 14, 14},
//18=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10,  0, 10, 10, 10, 10, 10, 10, 10, 26, 10, 10, 10, 10, 26, 26, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10},
//19=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11,  0, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 43, 11},
//20=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12,  0, 12, 12, 12, 24, 25, 12, 12, 12, 12, 24, 12, 12, 12, 12, 12, 24, 25, 12, 12, 12, 12, 24, 12, 12},
//21=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,  0, 22, 15, 15, 15, 15, 15, 15, 29, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15},
//22=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 21,  0, 15, 15, 15, 15, 15, 15, 21, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15},
//23=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17,  0, 17, 17, 17, 27, 28, 17, 17, 17, 17, 17, 17, 27, 17, 17, 17, 17, 17, 27, 17, 17, 17},
//24=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20,  0, 25, 20, 20, 20, 20, 30, 20, 20, 20, 20, 20, 30, 25, 20, 20, 20, 20, 30, 20, 20},
//25=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 24,  0, 20, 20, 20, 20, 24, 20, 20, 20, 20, 20, 24, 37, 20, 20, 20, 20, 24, 20, 20},
//26=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18,  0, 18, 18, 18, 18, 31, 32, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18},
//27=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23,  0, 28, 23, 23, 23, 23, 23, 23, 35, 23, 23, 23, 23, 23, 35, 23, 23, 23},
//28=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 27,  0, 23, 23, 23, 23, 23, 23, 27, 23, 23, 23, 23, 23, 27, 23, 23, 23},
//29=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21,  0, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21},
//30=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,  0, 24, 24, 24, 24, 24, 36, 24, 24, 24, 24, 24, 36, 24, 24},
//31=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26,  0, 32, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26},
//32=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 31,  0, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26},
//33=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,  0, 34, 16, 16, 16, 16, 39, 39, 16, 16, 16, 16},
//34=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 33,  0, 16, 16, 16, 16, 33, 33, 16, 16, 16, 16},
//35=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27,  0, 27, 27, 27, 27, 27, 41, 27, 27, 27},
//36=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30,  0, 30, 30, 30, 30, 30, 42, 30, 30},
//37=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,  0, 25, 25, 25, 25, 25, 25, 25},
//38=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 12,  8,  8,  8,  8,  8,  8,  8, 12,  8,  8,  8, 12, 12,  8,  8,  8,  8, 12,  8,  8,  8,  8,  8, 12, 12,  0,  8,  8,  8, 12,  8, 44},
//39=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33,  0, 40, 33, 33, 33, 33},
//40=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39,  0, 39, 39, 39, 39},
//41=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35, 35,  0, 35, 35, 35},
//42=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36,  0, 36, 36},
//43=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19,  0, 19},
//44=> 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  
  {0, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38,  0}
};

//Timer for sending neighbor discovery
static struct ctimer sendNDTimer;
rtimer_clock_t packetBuildingTime;
uint8_t ticTocFlag = 0;
static clock_time_t backOffDifference;

static uint8_t private_keep_alive[12];
static uint8_t gPkt_created = 0;

void (* up_msg_confirm)(int status, int num_tx) = NULL;
void (* up_msg_input)(const linkaddr_t *source) = NULL;

/*---------------------------------------------------------------------------*/
static void
packet_sent(void *ptr, int status, int num_tx)
{
  switch(status) {
  case MAC_TX_COLLISION:
    PRINTF("staticnet: collision after %d tx\n", num_tx);
    break; 
  case MAC_TX_NOACK:
    PRINTF("staticnet: noack after %d tx\n", num_tx);
    break;
  case MAC_TX_OK:
    PRINTF("staticnet: sent after %d tx\n", num_tx);
    break;
  default:
    PRINTF("staticnet: error %d after %d tx\n", status, num_tx);
  }
  up_msg_confirm(status,num_tx);
}

/*---------------------------------------------------------------------------*/
int
staticnet_output(void)
{
  RIMESTATS_ADD(tx);

#if BROADCAST_EXAMPLE == 0
  linkaddr_t const *finalReceiver = packetbuf_addr(PACKETBUF_ADDR_RECEIVER);
  if(packetbuf_hdralloc(1)) {
    uint8_t *buf = packetbuf_hdrptr();
    buf[0] = finalReceiver->u8[0];
  } else {
    PRINTF("Failed to create packet");
    return 0;
  }

  static linkaddr_t addrNext;

#if EXP_STAR_LIKE == 1
  addrNext.u8[0] = 1;
#elif EXP_LINEAR_NODES == 1
    addrNext.u8[0] = linkaddr_node_addr.u8[0] -1;
#else
  addrNext.u8[0] = routing_table[linkaddr_node_addr.u8[0]][finalReceiver->u8[0]];
#endif
  addrNext.u8[1] = 0;
  packetbuf_set_addr(PACKETBUF_ADDR_RECEIVER, &addrNext);
#endif

  packetbuf_compact();
  NETSTACK_LLSEC.send(packet_sent, NULL);
  return 1;
}

/*---------------------------------------------------------------------------*/
static void
input(void)
{
  uint8_t *data = packetbuf_dataptr();

  packetbuf_hdrreduce(1);
  if(data[0] == linkaddr_node_addr.u8[0]) {
    up_msg_input(packetbuf_addr(PACKETBUF_ADDR_SENDER));
  } else {
    static linkaddr_t addrFinal;
    addrFinal.u8[0] = *data;
    addrFinal.u8[1] = 0;
    packetbuf_set_addr(PACKETBUF_ADDR_RECEIVER, &addrFinal);
    packetbuf_set_addr(PACKETBUF_ADDR_SENDER, &linkaddr_node_addr);

    staticnet_output();
  }
}

/*---------------------------------------------------------------------------*/
void
staticnet_signup(void (* msg_confirm)(int status, int num_tx), void (* msg_input)(const linkaddr_t *source))
{
  up_msg_confirm = msg_confirm;
  up_msg_input = msg_input;
}

/*---------------------------------------------------------------------------*/
static void
create_keep_alive_full_packet(void *ptr, int status, int num_tx)
{
  // packetbuf_copyfrom("123456789012345678901234567890", 30);
  packetbuf_copyfrom(private_keep_alive, 12);
  linkaddr_t addr;
  addr.u8[0] = 1;
  addr.u8[1] = 0;
  packetbuf_set_addr(PACKETBUF_ADDR_RECEIVER, &addr);
  packetbuf_set_addr(PACKETBUF_ADDR_SENDER, &linkaddr_node_addr);

  staticnet_output();
}

/*---------------------------------------------------------------------------*/
static void
send_keep_alive(void *ptr)
{
  if(gPkt_created >= MAX_GENERATED_KA) {
      return;
  }
  gPkt_created++;


#if USE_NEW_FEATURES == 1
  clock_time_t backoff = CLOCK_SECOND*KEEP_ALIVE_INTERVAL - backOffDifference;//ms
  backOffDifference = 0;
  backoff += backOffDifference;
  ctimer_set(&sendNDTimer, backoff, send_keep_alive, NULL);


  //A slightly cheat
  linkaddr_t addr;
  addr.u8[1] = 0;
#if EXP_LINEAR_NODES == 1
  addr.u8[0] = linkaddr_node_addr.u8[0]-1;
#else
  addr.u8[0] = routing_table[linkaddr_node_addr.u8[0]][1];
#endif

  if(!create_aggregation_frame(private_keep_alive, 12, &addr, create_keep_alive_full_packet, ROUTING_PACKETS_TIMEOUT)) {
    PRINTF("Failed creating KA!\n");
  }

#else
  clock_time_t backoff = CLOCK_SECOND*KEEP_ALIVE_INTERVAL - backOffDifference;//ms
  backOffDifference = (CLOCK_SECOND*((random_rand()%BACKOFF_TIME)))/1000;
  backoff += backOffDifference;
  ctimer_set(&sendNDTimer, backoff, send_keep_alive, NULL);

  create_keep_alive_full_packet(NULL,0,1);
#endif

  printf("Net sending to 1\n");
}

/*---------------------------------------------------------------------------*/
static void
init(void)
{
  PRINTF("staticnet started\n");
  queuebuf_init();
  aggregation_init();
  packetbuf_clear();

  linkaddr_t addrThis;
  addrThis.u8[0] = 1;
  addrThis.u8[1] = 0;

#if KEEP_ALIVE_SERVICE == 1
  #if BROADCAST_EXAMPLE == 0
    #if DOUBLE_NODE_NULL == 0
      if(!linkaddr_cmp(&addrThis, &linkaddr_node_addr)) {

      #if USE_NEW_FEATURES == 1
        backOffDifference = 0;
        clock_time_t backoff = CLOCK_SECOND/8;//ms
        ctimer_set(&sendNDTimer, backoff, send_keep_alive, NULL);
      #else /*USE_NEW_FEATURES*/
        backOffDifference = (CLOCK_SECOND*((random_rand()%BACKOFF_TIME)))/1000;
        clock_time_t backoff = CLOCK_SECOND*KEEP_ALIVE_INTERVAL + backOffDifference;//ms
        ctimer_set(&sendNDTimer, backoff, send_keep_alive, NULL);
      #endif /*USE_NEW_FEATURES*/
      }
    #endif /*DOUBLE_NODE_NULL*/
    #if DOUBLE_NODE_NULL == 1
      if(linkaddr_cmp(&addrThis, &linkaddr_node_addr)) {
        NETSTACK_RDC.on();
      }
    #endif /*DOUBLE_NODE_NULL*/
  #endif /*BROADCAST_EXAMPLE*/
#endif /*KEEP_ALIVE_SERVICE*/


  static uint8_t selfAddrValue;

  selfAddrValue = linkaddr_node_addr.u8[0];
  sprintf((char *)private_keep_alive, "### %02u %02u###", selfAddrValue,
                                                        selfAddrValue);
}


/*---------------------------------------------------------------------------*/
const struct network_driver staticnet_driver = {
  "staticnet",
  init,
  input
};
/** @} */
